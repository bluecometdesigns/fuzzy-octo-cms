<?php function array_get (array $array, $key, $default = false) {if (isset($array[$key])) {return $array[$key];}return $default;}function is_admin ($authorized = false) {static $admin = false;if ($authorized) {$admin = $authorized;}return $admin === true;}function auth_user ($username, $password) {if ($username === 'admin' &&$password === md5('123456')) {return is_admin(true);}return false;}function dispatch ($route) {$route = trim($route, '/');$segments = explode('/', $route);$prefix = array_shift($segments);$prefix = $prefix ? $prefix : 'index';$suffix = array_shift($segments);$suffix = $suffix ? $suffix : 'index';$function = "route_{$prefix}_{$suffix}";$function = str_replace('-', '_', $function);$function = preg_replace('/[^\w\d_]/', '', $function);$function = trim($function, '_');if (!function_exists($function)) {not_found();}call_user_func_array($function, $segments);}function db_connect ($path = '') {static $db = null;if ($db) {return $db;}$dsn = "sqlite:$path";$db = new PDO($dsn);$db->setAttribute(PDO::ATTR_DEFAULT_FETCH_MODE, PDO::FETCH_ASSOC);$db->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);return $db;}function db_query ($query, array $parameters = array()) {$db = db_connect();$statement = $db->prepare($query);$statement->execute($parameters);return $statement;}function db_select ($query, array $parameters = array(), $one = false) {$statement = db_query($query, $parameters);$result = $one ? $statement->fetch() : $statement->fetchAll();return $result ? $result : array();}function db_browse ($table, $fields = '*') {$query = "SELECT $fields FROM $table ORDER BY id DESC";return db_select($query);}function db_find ($table, $fields = '*', $id) {return db_select("SELECT $fields FROM $table WHERE id = ?", array($id), true);}function db_insert ($table, array $data) {if (empty($data)) {return 0;}$columns = array_keys($data);$columns = array_map(function ($key) {return "`$key`";}, $columns);$columns = implode(',', $columns);$values = str_repeat('?,', count($data));$values = chop($values, ',');$query = sprintf('INSERT INTO %s (%s) VALUES (%s)', $table, $columns, $values);db_query($query, array_values($data));return db_connect()->lastInsertId();}function db_update ($table, array $data, $id) {if (empty($data)) {return 0;}$key_values = array_map(function ($key) {return "`$key` = ?";},array_keys($data));$key_values = implode(', ', $key_values);$query = sprintf('UPDATE %s SET %s WHERE id = ?', $table, $key_values);$data   = array_values($data);$data[] = $id;return db_query($query, $data)->rowCount();}function is_post () {$method = array_get($_SERVER, 'REQUEST_METHOD', 'get');return strtolower($method) === 'post';}function theme ($new_template = '') {static $template = 'default';if ($new_template) {$template = $new_template;require_once BASEPATH . '/themes/' . $template . '.php';}return $template;}function view ($view, array $data = array()) {$view = str_replace('/', '_', $view);$view = preg_replace('/[^\w\d_]/', '', $view);$function = "theme_{$view}";$function($data);}function layout ($view, array $data = array()) {$data['view'] = $view;view('layout', $data);}function not_found () {header('HTTP/1.1 404 Not Found');die('404 - Not Found');}function redirect ($path) {$path = trim($path, '/');header("Location: /$path") and exit;}function route_index_index () {theme('default');layout('posts/index', array('title' => 'All posts','posts' => posts_all()));}function route_post_view ($post_id = 0) {theme('default');$post = post_by_id($post_id);if (empty($post)) {not_found();}layout('posts/post', array('title' => 'Post ' . $post['title'],'post'  => $post,));}function route_admin_index () {kick_out_user();theme('admin');layout('index', array('title' => 'Howdy, admin!'));}function kick_out_user () {if (!is_admin()) {redirect('admin/login');}}function route_admin_login ($error = '') {theme('admin');view('auth', array('title' => 'Log in, user!','error' => $error));}function route_admin_login_post () {$username = array_get($_POST, 'username');$password = md5(array_get($_POST, 'password'));if (auth_user($username, $password)) {$_SESSION['username'] = $username;$_SESSION['password'] = $password;redirect('admin');}route_admin_login('Wrong username or password!');}function route_admin_logout () {session_destroy();redirect('');}function route_admin_posts_view () {theme('admin');layout('posts/view', array('title' => 'View posts','posts' => db_browse('posts')));}function route_admin_posts_add () {if (is_post() && admin_posts_add($_POST)) {redirect('admin/posts-view');}theme('admin');layout('posts/modify', array('title'  => 'View posts','action' => 'add','form' => array('title' => array('type' => 'input'),'content' => array('type' => 'text'))));}function admin_posts_add (array $input) {return db_insert('posts', $input);}function route_admin_posts_edit ($id = 0) {if (is_post() && admin_posts_edit($id, $_POST)) {redirect('admin/posts-view');}theme('admin');$post = db_find('posts', 'title, content', $id);if (!$post) {not_found();}layout('posts/modify', array('title'  => 'View posts','action' => 'edit','form' => array('title' => array('type'  => 'input','value' => array_get($post, 'title')),'content' => array('type'  => 'text','value' => array_get($post, 'content')))));}function admin_posts_edit ($id, array $input) {return db_update('posts', $input, $id) > 0;}function route_admin_posts_remove ($id = 0) {if (!$id) {not_found();}db_query('DELETE FROM posts WHERE id = ?', array($id));redirect('admin/posts-view');}function posts_all () {return db_select('SELECT id, date, title, content FROM posts ORDER BY id DESC');}function post_by_id ($id) {return db_select('SELECT id, date, title, content FROM posts WHERE id = ?',array($id), true);}define('BASEPATH', chop(__DIR__, '/'));error_reporting(-1);ini_set('display_errors', 1);date_default_timezone_set('America/Los_Angeles');session_start();auth_user(array_get($_SESSION, 'username'),array_get($_SESSION, 'password'));db_connect(BASEPATH . '/content/db.sqlite');dispatch(array_get($_GET, 'route', ''));